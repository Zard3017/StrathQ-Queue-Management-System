<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Join Queue - StrathQ</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
</head>
<body>
{% load static %}

   <div class="row">
    {% for department, services in departments.items %}
    <div class="col-lg-4 col-md-6 mb-4">
        <div class="card h-100 shadow-sm">
            <div class="card-body d-flex flex-column">
                <h5 class="card-title">{{ department }}</h5>

                <div class="mt-auto">
                    <form action="{% url 'my_queues' %}" method="POST">
                        {% csrf_token %}
                        <label for="{{ department|slugify }}-service" class="form-label">Select a service:</label>
                        <select class="form-select mb-3 service-select" 
                                id="{{ department|slugify }}-service" 
                                name="service"
                                data-staff-container="#{{ department|slugify }}-staff-list"
                                data-join-button="#{{ department|slugify }}-join-btn">
                            <option selected disabled value="">Choose a service...</option>
                            {% for service in services %}
                                <option value="{{ service.id }}">{{ service.name }}</option>
                            {% endfor %}
                        </select>

                        <!-- Staff list will be injected here by JavaScript -->
                        <div class="staff-list-container mb-3" id="{{ department|slugify }}-staff-list"></div>

                        <input type="hidden" name="staff_id" class="selected-staff-id">

                        <button type="submit" id="{{ department|slugify }}-join-btn" class="btn btn-primary w-100" disabled>
                            Join {{ department }} Queue
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>


    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.service-select').forEach(select => {
        select.addEventListener('change', function() {
            const serviceId = this.value;
            const staffContainer = document.querySelector(this.dataset.staffContainer);
            const joinButton = document.querySelector(this.dataset.joinButton);
            const hiddenStaffIdInput = this.closest('form').querySelector('.selected-staff-id');

            // Reset UI
            staffContainer.innerHTML = '';
            joinButton.disabled = true;
            hiddenStaffIdInput.value = '';

            // Fetch staff from API
            fetch(`/api/staff/${serviceId}/`)
                .then(response => response.json())
                .then(data => {
                    const staffList = data.staff;

                    if (staffList.length > 0) {
                        let staffHtml = '<p class="form-label mb-1">Select available staff:</p><div class="list-group">';
                        staffList.forEach(staff => {
                            const isAvailable = staff.status === 'online';
                            const disabledAttr = isAvailable ? '' : 'disabled';
                            const statusClass = isAvailable ? 'text-success' : 'text-muted';
                            const statusText = isAvailable ? 'Online' : 'Unavailable';

                            staffHtml += `
                                <label class="list-group-item d-flex justify-content-between align-items-center py-2">
                                    <div>
                                        <input class="form-check-input me-2" type="radio" name="staff_selection" value="${staff.id}" ${disabledAttr}>
                                        ${staff.name}
                                    </div>
                                    <span class="badge bg-light ${statusClass} rounded-pill">${statusText}</span>
                                </label>
                            `;
                        });
                        staffHtml += '</div>';
                        staffContainer.innerHTML = staffHtml;

                        // Event listener for staff radio button selection
                        staffContainer.addEventListener('change', e => {
                            if (e.target.name === 'staff_selection') {
                                hiddenStaffIdInput.value = e.target.value;
                                joinButton.disabled = false;
                            }
                        });

                    } else {
                        staffContainer.innerHTML = '<div class="alert alert-warning p-2" role="alert">No staff available for this service.</div>';
                    }
                })
                .catch(error => {
                    console.error('Error fetching staff:', error);
                    staffContainer.innerHTML = '<div class="alert alert-danger p-2" role="alert">Error loading staff.</div>';
                });
        });
    });
});
</script>

</body>
</html>
